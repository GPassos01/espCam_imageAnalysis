name: ğŸš€ Auto Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    name: ğŸ“¦ Create GitHub Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ·ï¸ Get version
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Release version: $VERSION"
    
    - name: ğŸ“ Generate Release Notes
      id: notes
      run: |
        # Extract version from CHANGELOG.md
        VERSION="${{ steps.version.outputs.VERSION }}"
        
        # Create release notes
        cat > release_notes.md << EOF
        # ğŸš€ ESP32-CAM Flood Monitor $VERSION
        
        ## Sistema de Monitoramento Inteligente para DetecÃ§Ã£o de MudanÃ§as Fluviais
        
        ### âœ… **Principais Funcionalidades**
        - **Sistema ESP32-CAM completo** com anÃ¡lise inteligente RGB565
        - **Algoritmo de comparaÃ§Ã£o** por blocos 32x32 pixels
        - **Monitor cientÃ­fico Python** com argumentos CLI
        - **Duas versÃµes**: INTELLIGENT (economia de dados) e SIMPLE (baseline)
        - **ComunicaÃ§Ã£o MQTT robusta** com reconexÃ£o automÃ¡tica
        - **DocumentaÃ§Ã£o profissional** completa
        
        ### ğŸ”§ **Melhorias TÃ©cnicas**
        - VersÃ£o INTELLIGENT recriada e otimizada
        - Estrutura de projeto profissional
        - Sistema de backup automÃ¡tico
        - Scripts de teste para comparaÃ§Ã£o de versÃµes
        - Workflows GitHub Actions automatizados
        
        ### ğŸ§ª **Status dos Testes**
        - âœ… **Core System**: Firmware + Servidor testados e funcionais
        - ğŸš§ **Tools**: Scripts em beta para prÃ³ximas versÃµes
        
        ### ğŸ“¥ **InstalaÃ§Ã£o RÃ¡pida**
        \`\`\`bash
        # OpÃ§Ã£o 1: Clone do repositÃ³rio
        git clone https://github.com/GPassos01/espCam_imageAnalysis.git
        cd espCam_imageAnalysis
        
        # OpÃ§Ã£o 2: Download dos binÃ¡rios (veja Assets abaixo)
        # - firmware-intelligent.zip
        # - firmware-simple.zip  
        # - esp32-cam-monitor-$VERSION.tar.gz
        \`\`\`
        
        ### ğŸ”§ **ConfiguraÃ§Ã£o RÃ¡pida**
        1. **ESP32**: Flash firmware (.bin files)
        2. **Servidor**: Configure Python + MQTT
        3. **Monitor**: Execute \`python mqtt_data_collector.py\`
        
        ### ğŸ“– **DocumentaÃ§Ã£o Completa**
        - [README.md](README.md) - Guia completo
        - [CHANGELOG.md](CHANGELOG.md) - HistÃ³rico de mudanÃ§as
        - [CONTRIBUTING.md](CONTRIBUTING.md) - Como contribuir
        
        ### ğŸ¯ **PrÃ³ximo Release**: v1.1.0 com ferramentas completas
        
        ---
        **Por Gabriel Passos - IGCE/UNESP**  
        **Sistema de Monitoramento de Enchentes - Projeto CientÃ­fico**
        EOF
        
        echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: ğŸ”§ Setup ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.2.5
        target: esp32
    
    - name: ğŸ—ï¸ Build Release Firmware
      working-directory: src/firmware
      run: |
        # Build both versions for release
        for version in intelligent simple; do
          echo "ğŸ”§ Building $version version..."
          echo "$version" | tr '[:lower:]' '[:upper:]' > main/ACTIVE_VERSION.txt
          idf.py fullclean
          idf.py build
          
          # Create release directory
          mkdir -p ../../release-assets/$version
          cp build/esp32_cam_monitor.bin ../../release-assets/$version/
          cp build/bootloader/bootloader.bin ../../release-assets/$version/
          cp build/partition_table/partition-table.bin ../../release-assets/$version/
          
          # Create flash script
          cat > ../../release-assets/$version/flash.sh << 'FLASH_EOF'
        #!/bin/bash
        echo "ğŸ”§ ESP32-CAM Flash Script - VersÃ£o: $version"
        echo "Port padrÃ£o: /dev/ttyUSB0 (altere se necessÃ¡rio)"
        
        PORT=${1:-/dev/ttyUSB0}
        
        echo "ğŸ“¡ Fazendo flash no ESP32-CAM..."
        esptool.py --chip esp32 \
          --port $PORT \
          --baud 460800 \
          --before default_reset \
          --after hard_reset \
          write_flash -z \
          --flash_mode dio \
          --flash_freq 40m \
          --flash_size detect \
          0x1000 bootloader.bin \
          0x10000 esp32_cam_monitor.bin \
          0x8000 partition-table.bin
        
        echo "âœ… Flash concluÃ­do!"
        FLASH_EOF
          chmod +x ../../release-assets/$version/flash.sh
          
          # Create README for version
          cat > ../../release-assets/$version/README.md << VERSION_EOF
        # ESP32-CAM Firmware - VersÃ£o ${version^^}
        
        ## ğŸ“ Arquivos
        - \`esp32_cam_monitor.bin\` - Firmware principal
        - \`bootloader.bin\` - Bootloader ESP32
        - \`partition-table.bin\` - Tabela de partiÃ§Ãµes
        - \`flash.sh\` - Script de flash automatizado
        
        ## ğŸ”§ Flash Manual
        \`\`\`bash
        # Via ESP-IDF
        idf.py -p /dev/ttyUSB0 flash
        
        # Via esptool
        ./flash.sh [porta]
        \`\`\`
        
        ## âš™ï¸ ConfiguraÃ§Ã£o
        1. Edite \`config.h\` se necessÃ¡rio
        2. Configure WiFi e MQTT
        3. FaÃ§a upload do firmware
        4. Execute monitor Python
        VERSION_EOF
          
          # Create ZIP for version
          cd ../../release-assets
          zip -r firmware-$version.zip $version/
          cd ..
        done
    
    - name: ğŸ“¦ Create Release Package
      run: |
        # Create complete release package
        mkdir -p complete-package
        
        # Copy firmware builds
        cp -r release-assets/ complete-package/firmware/
        
        # Copy server
        cp -r src/server/ complete-package/
        rm -rf complete-package/server/__pycache__
        
        # Copy essential documentation
        cp README.md CHANGELOG.md LICENSE complete-package/
        cp CONTRIBUTING.md CODE_OF_CONDUCT.md complete-package/
        
        # Create installation script
        cat > complete-package/install.sh << 'INSTALL_EOF'
        #!/bin/bash
        # ESP32-CAM Flood Monitor Installation Script
        # VersÃ£o: ${{ steps.version.outputs.VERSION }}
        # Por Gabriel Passos - IGCE/UNESP
        
        set -e
        
        echo "ğŸš€ ESP32-CAM Flood Monitor Installation"
        echo "VersÃ£o: ${{ steps.version.outputs.VERSION }}"
        echo "========================================="
        
        # Check prerequisites
        echo "ğŸ” Verificando prÃ©-requisitos..."
        
        if ! command -v python3 &> /dev/null; then
            echo "âŒ Python 3 nÃ£o encontrado. Instale Python 3.9+"
            exit 1
        fi
        
        PYTHON_VERSION=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2)
        echo "âœ… Python $PYTHON_VERSION encontrado"
        
        # Install Python dependencies
        echo "ğŸ“¦ Instalando dependÃªncias Python..."
        cd server
        python3 -m venv venv
        source venv/bin/activate
        pip install paho-mqtt matplotlib numpy scipy pillow
        
        echo "âœ… InstalaÃ§Ã£o concluÃ­da!"
        echo ""
        echo "ğŸ“– PrÃ³ximos passos:"
        echo "1. Configure seu ESP32-CAM com firmware da pasta firmware/"
        echo "2. Edite configuraÃ§Ãµes MQTT"
        echo "3. Execute: cd server && source venv/bin/activate && python mqtt_data_collector.py"
        echo ""
        echo "ğŸ“š Consulte README.md para instruÃ§Ãµes detalhadas"
        INSTALL_EOF
        chmod +x complete-package/install.sh
        
        # Create final archive
        tar -czf esp32-cam-monitor-${{ steps.version.outputs.VERSION }}.tar.gz complete-package/
    
    - name: ğŸš€ Create GitHub Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        release_name: ESP32-CAM Flood Monitor ${{ steps.version.outputs.VERSION }}
        body: ${{ steps.notes.outputs.RELEASE_NOTES }}
        draft: false
        prerelease: false
    
    - name: ğŸ“¤ Upload Complete Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./esp32-cam-monitor-${{ steps.version.outputs.VERSION }}.tar.gz
        asset_name: esp32-cam-monitor-${{ steps.version.outputs.VERSION }}.tar.gz
        asset_content_type: application/gzip
    
    - name: ğŸ“¤ Upload Firmware INTELLIGENT
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-assets/firmware-intelligent.zip
        asset_name: firmware-intelligent.zip
        asset_content_type: application/zip
    
    - name: ğŸ“¤ Upload Firmware SIMPLE
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-assets/firmware-simple.zip
        asset_name: firmware-simple.zip
        asset_content_type: application/zip
    
    - name: ğŸ“¢ Release Summary
      run: |
        echo "âœ… Release ${{ steps.version.outputs.VERSION }} criado com sucesso!"
        echo "ğŸ“¦ Assets criados:"
        echo "  - esp32-cam-monitor-${{ steps.version.outputs.VERSION }}.tar.gz (pacote completo)"
        echo "  - firmware-intelligent.zip (firmware inteligente)"
        echo "  - firmware-simple.zip (firmware simples)"
        echo ""
        echo "ğŸ”— URL: ${{ steps.create_release.outputs.html_url }}" 