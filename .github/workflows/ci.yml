name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [published]

env:
  ESP_IDF_VERSION: v5.2.5
  PYTHON_VERSION: 3.9

jobs:
  # ===============================================
  # ESP32 Firmware Build and Test
  # ===============================================
  firmware-build:
    name: ðŸ”§ ESP32 Firmware Build
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        version: [intelligent, simple]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: ðŸ”§ Setup ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: ${{ env.ESP_IDF_VERSION }}
        target: esp32
    
    - name: ðŸ—ï¸ Build Firmware (${{ matrix.version }})
      working-directory: src/firmware
      run: |
        # Configure version
        echo "${{ matrix.version }}" | tr '[:lower:]' '[:upper:]' > main/ACTIVE_VERSION.txt
        
        # Build
        idf.py build
        
        # Check build artifacts
        ls -la build/
        test -f build/esp32_cam_monitor.bin
    
    - name: ðŸ“¦ Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.version }}
        path: |
          src/firmware/build/*.bin
          src/firmware/build/*.elf
          src/firmware/build/bootloader/bootloader.bin
          src/firmware/build/partition_table/partition-table.bin
        retention-days: 30

  # ===============================================
  # Python Server Test
  # ===============================================
  server-test:
    name: ðŸ Python Server Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ðŸ“¦ Install Dependencies
      working-directory: src/server
      run: |
        python -m pip install --upgrade pip
        pip install paho-mqtt matplotlib numpy scipy pillow pytest
        pip install -r requirements.txt || echo "requirements.txt not found"
    
    - name: ðŸ§ª Run Server Tests
      working-directory: src/server
      run: |
        # Basic import test
        python -c "import mqtt_data_collector; print('âœ… Import successful')"
        
        # Help test
        python mqtt_data_collector.py --help
        
        # Syntax check
        python -m py_compile mqtt_data_collector.py
    
    - name: ðŸ“Š Test Data Directory Structure
      run: |
        mkdir -p data/{images/{intelligent,simple},databases,reports}
        python -c "
        import os
        required_dirs = ['data/images/intelligent', 'data/images/simple', 'data/databases']
        for dir_path in required_dirs:
            assert os.path.exists(dir_path), f'Missing: {dir_path}'
        print('âœ… Data structure OK')
        "

  # ===============================================
  # Documentation Check
  # ===============================================
  documentation:
    name: ðŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ” Check Required Files
      run: |
        required_files=(
          "README.md"
          "CHANGELOG.md" 
          "CONTRIBUTING.md"
          "LICENSE"
          "CODE_OF_CONDUCT.md"
          "SECURITY.md"
          "SUPPORT.md"
        )
        
        for file in "${required_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
    
    - name: ðŸ“– Check README structure
      run: |
        # Check if README has key sections
        required_sections=(
          "Sobre o Projeto"
          "Funcionalidades"
          "InstalaÃ§Ã£o"
          "Uso"
          "Contribuir"
        )
        
        for section in "${required_sections[@]}"; do
          if grep -q "$section" README.md; then
            echo "âœ… Section '$section' found"
          else
            echo "âš ï¸ Section '$section' not found"
          fi
        done

  # ===============================================
  # Tools Validation (Beta)
  # ===============================================
  tools-validation:
    name: ðŸ› ï¸ Tools Validation (Beta)
    runs-on: ubuntu-latest
    continue-on-error: true  # Beta tools may fail
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ” Check Tools Structure
      run: |
        echo "ðŸ§ª Validating tools structure..."
        
        tools_dirs=(
          "tools/build"
          "tools/development" 
          "tools/deployment"
          "tools/analysis"
        )
        
        for dir in "${tools_dirs[@]}"; do
          if [[ -d "$dir" ]]; then
            echo "âœ… $dir exists"
            ls -la "$dir"
          else
            echo "âš ï¸ $dir missing"
          fi
        done
    
    - name: ðŸ”§ Test Tools Syntax
      run: |
        echo "ðŸ” Checking shell scripts syntax..."
        
        find tools/ -name "*.sh" -type f | while read script; do
          echo "Checking $script..."
          bash -n "$script" && echo "âœ… $script syntax OK" || echo "âŒ $script has syntax errors"
        done

  # ===============================================
  # Security Scan
  # ===============================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ” Run Secret Scan
      run: |
        echo "ðŸ” Scanning for secrets..."
        
        # Check for common secret patterns
        if grep -r -i "password\s*=" src/ || \
           grep -r -i "secret\s*=" src/ || \
           grep -r -i "api[_-]key" src/; then
          echo "âš ï¸ Potential secrets found"
          exit 1
        else
          echo "âœ… No obvious secrets found"
        fi
    
    - name: ðŸ“‹ License Check
      run: |
        if [[ -f "LICENSE" ]]; then
          echo "âœ… License file exists"
          head -n 5 LICENSE
        else
          echo "âŒ No license file found"
          exit 1
        fi

  # ===============================================
  # Release Build (only on tags)
  # ===============================================
  release-build:
    name: ðŸš€ Release Build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [firmware-build, server-test, documentation]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ·ï¸ Get Version
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: ðŸ”§ Setup ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: ${{ env.ESP_IDF_VERSION }}
        target: esp32
    
    - name: ðŸ—ï¸ Build Release Firmware
      working-directory: src/firmware
      run: |
        # Build both versions
        for version in intelligent simple; do
          echo "Building $version version..."
          echo "$version" | tr '[:lower:]' '[:upper:]' > main/ACTIVE_VERSION.txt
          idf.py fullclean
          idf.py build
          
          # Create release directory
          mkdir -p ../../release/$version
          cp build/esp32_cam_monitor.bin ../../release/$version/
          cp build/bootloader/bootloader.bin ../../release/$version/
          cp build/partition_table/partition-table.bin ../../release/$version/
        done
    
    - name: ðŸ“¦ Create Release Archive
      run: |
        # Create release package
        mkdir -p release-package
        
        # Copy firmware builds
        cp -r release/ release-package/firmware/
        
        # Copy server
        cp -r src/server/ release-package/
        
        # Copy documentation
        cp README.md CHANGELOG.md LICENSE release-package/
        
        # Create installation script
        cat > release-package/install.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ ESP32-CAM Flood Monitor Installation"
        echo "VersÃ£o: ${{ steps.version.outputs.VERSION }}"
        echo "Por Gabriel Passos - IGCE/UNESP"
        echo ""
        echo "ðŸ“‹ PrÃ©-requisitos:"
        echo "- ESP-IDF v5.0+"
        echo "- Python 3.9+"
        echo ""
        echo "ðŸ“– Consulte README.md para instruÃ§Ãµes completas"
        EOF
        chmod +x release-package/install.sh
        
        # Create archive
        tar -czf esp32-cam-monitor-${{ steps.version.outputs.VERSION }}.tar.gz release-package/
    
    - name: ðŸ“¤ Upload Release Assets
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ steps.version.outputs.VERSION }}
        path: esp32-cam-monitor-${{ steps.version.outputs.VERSION }}.tar.gz

  # ===============================================
  # Notification
  # ===============================================
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [firmware-build, server-test, documentation]
    if: always()
    
    steps:
    - name: ðŸ“Š Build Status
      run: |
        echo "ðŸ” Build Status Summary:"
        echo "Firmware Build: ${{ needs.firmware-build.result }}"
        echo "Server Test: ${{ needs.server-test.result }}" 
        echo "Documentation: ${{ needs.documentation.result }}"
        
        if [[ "${{ needs.firmware-build.result }}" == "success" && 
              "${{ needs.server-test.result }}" == "success" && 
              "${{ needs.documentation.result }}" == "success" ]]; then
          echo "âœ… All checks passed!"
        else
          echo "âŒ Some checks failed"
          exit 1
        fi 